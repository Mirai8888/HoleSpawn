"""
Synthesize network analysis + node profiles into a cohesive network vulnerability report (network_report.md).
"""

import json
import logging
from typing import Any

from holespawn.cost_tracker import CostTracker
from holespawn.llm import call_llm

from .graph_analysis import NetworkAnalysis, network_analysis_to_dict

logger = logging.getLogger(__name__)

VULNERABILITY_MAP_SYSTEM = """You are an analyst producing a **network vulnerability map** from the exact data provided.

CRITICAL: Use ONLY usernames, metrics, and counts that appear in the data below. Do NOT invent usernames, connection counts, roles, or community descriptions. If the data shows one community, say "single community" or "star topology"; do NOT invent multiple communities or bridge nodes. If a section has no data (e.g. no key node profiles), say "No data provided" or summarize only what is present.

You receive:
1. Network topology (nodes, edges, communities, density).
2. Key node profiles (if any): psychological summary, position, role, approach, cascade, resistance.
3. Lists of bridge nodes, amplifiers, gatekeepers, vulnerable entry points, influence paths.

Produce a markdown report with exactly these sections (use these headers). Be evidence-based: every @username and every number must come from the data.

## Network topology summary
- State the exact node count, edge count, density, and number of communities from the data. One short paragraph. If there is only one community, describe it as a single community (e.g. star around one hub); do not invent sub-communities.

## Community breakdown
For each community ID that appears in the data: key members (usernames from the data only), size. Do not invent themes or usernames.

## Optimal entry points
List only usernames that appear in the bridge_nodes, vulnerable_entry_points, or amplifiers data. Format: **@username**: 1â€“2 sentences using only metrics from the data (e.g. betweenness, degree). Maximum 10 entries.

## Propagation playbook
Base only on influence_paths and the provided graph structure. Do not invent paths or usernames.

## Amplification strategy
Reference only usernames from the amplifiers/bridge lists. Do not invent sequences.

## Resistance map
Infer only from the structure described (e.g. "no counter-hubs" if the data shows one hub). Do not invent resistant actors.

## Cross-community bridges
If the data shows only one community, say "Single community; no cross-community bridges." Otherwise describe only bridge nodes that appear in the data.

Do not add preamble. Output only the markdown document."""


def generate_network_report(
    analysis: NetworkAnalysis,
    node_profiles: dict[str, dict[str, Any]],
    target_username: str,
    *,
    tracker: CostTracker | None = None,
    provider: str | None = None,
    model: str | None = None,
    calls_per_minute: int = 20,
) -> str:
    """
    Generate network_report.md content from NetworkAnalysis and key-node profiles.
    Uses one LLM call to synthesize topology + communities + entry points + playbook + resistance.
    """
    data = network_analysis_to_dict(analysis)
    # Build user payload
    density = (data.get("sanity_check") or {}).get("density", 0)
    parts = [
        "## Topology",
        f"Target: @{target_username.strip().lstrip('@')}",
        f"Nodes: {len(data['nodes'])}, Edges: {len(data['edges'])}, Density: {density}",
        f"Communities: {len(data['communities'])}",
        "Sanity: " + json.dumps(data.get("sanity_check") or {}, indent=2),
        "",
        "## Community metrics (per-community size, density, hub, bridge count)",
        json.dumps(data.get("community_metrics") or {}, indent=2),
        "",
        "## Community profiles",
        json.dumps(data["community_profiles"], indent=2),
        "",
        "## Bridge nodes (top 15)",
        json.dumps(data["bridge_nodes"][:15], indent=2),
        "",
        "## Amplifiers (top 10)",
        json.dumps(data["amplifiers"][:10], indent=2),
        "",
        "## Gatekeepers (sample)",
        json.dumps(data["gatekeepers"][:15], indent=2),
        "",
        "## Vulnerable entry points",
        json.dumps(data["vulnerable_entry_points"][:15], indent=2),
        "",
        "## Influence paths (target -> key nodes)",
        json.dumps(data["influence_paths"][:10], indent=2),
        "",
        "## Key node profiles (psychological + position + role + approach + cascade + resistance)",
    ]
    for username, prof in list(node_profiles.items())[:25]:
        parts.append(
            f"\n### @{username}\n"
            + f"Summary: {prof.get('profile_summary', '')[:400]}\n"
            + f"Position: {prof.get('position_summary', '')}\n"
            + f"Role: {prof.get('role', '')}\n"
            + f"Approach: {json.dumps(prof.get('approach_vectors', []))}\n"
            + f"Cascade: {prof.get('cascade', '')}\n"
            + f"Resistance: {prof.get('resistance', '')}"
        )
    user_content = "\n".join(parts)
    raw = call_llm(
        VULNERABILITY_MAP_SYSTEM,
        user_content,
        provider_override=provider,
        model_override=model,
        max_tokens=4096,
        operation="network_vulnerability_map",
        tracker=tracker,
        calls_per_minute=calls_per_minute,
    )
    return raw.strip()
